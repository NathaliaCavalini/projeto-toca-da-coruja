<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil – Toca da Coruja</title>
    <link rel="stylesheet" href="../css/perfil.css" />
    <link rel="icon" href="../imagens/favicon.png" type="image/png">
</head>

<body>
    <div class="perfil-container">
        <div class="perfil-card">

            <!-- Botão voltar (caixa única com seta + texto) -->
            <a href="home.html" class="back-box" aria-label="Voltar para a página inicial">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" fill="none" />
                </svg>
                <span>Voltar à home</span>
            </a>

            <!-- Conteúdo do card (apenas 1 vez) -->
            <h1>Meu Perfil</h1>
            <p>Atualize suas informações na Toca da Coruja</p>

            <img id="user-photo" src="../imagens/user.png" alt="Foto do usuário">

            <form id="profile-form">
                <input type="text" id="username" placeholder="Nome de usuário" />
                <input type="email" id="email" placeholder="E-mail" disabled />
                <input type="file" id="photo-file" accept="image/*" />
                <button type="submit" class="btn">Salvar Alterações</button>
            </form>

            <div class="link">
                <button id="logout-btn" class="btn-logout">Sair da Conta</button>
            </div>

        </div> <!-- .perfil-card -->
    </div> <!-- .perfil-container -->

    <!-- JS (mantido: imports + lógica) -->
    <script type="module">
        import { auth, db, storage } from "../js/firebase-config.js";
        import {
            onAuthStateChanged,
            updateProfile,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import {
            doc,
            setDoc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import {
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

        const usernameInput = document.getElementById("username");
        const emailInput = document.getElementById("email");
        const photoFileInput = document.getElementById("photo-file");
        const userPhoto = document.getElementById("user-photo");
        const profileForm = document.getElementById("profile-form");
        const logoutBtn = document.getElementById("logout-btn");

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }

            usernameInput.value = user.displayName || "";
            emailInput.value = user.email || "";
            userPhoto.src = user.photoURL || "../imagens/user.png";

            try {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                if (snap.exists() && snap.data().photoURL) {
                    userPhoto.src = snap.data().photoURL;
                }
            } catch (err) {
                console.warn("Erro ao carregar dados do Firestore:", err);
            }
        });

        profileForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("Usuário não encontrado.");
                return;
            }

            try {
                let photoURL = user.photoURL || "";

                if (photoFileInput.files[0]) {
                    const file = photoFileInput.files[0];
                    const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
                    const fileRef = ref(storage, `avatars/${user.uid}/${Date.now()}_${safeName}`);

                    // preview imediato
                    userPhoto.src = URL.createObjectURL(file);

                    // upload
                    const snapshot = await uploadBytes(fileRef, file);

                    // pega URL pública
                    photoURL = await getDownloadURL(snapshot.ref);
                }

                // atualiza perfil no Auth
                await updateProfile(user, {
                    displayName: usernameInput.value.trim(),
                    photoURL
                });

                // atualiza dados no Firestore
                await setDoc(doc(db, "usuarios", user.uid), {
                    displayName: usernameInput.value.trim(),
                    email: user.email,
                    photoURL,
                    updatedAt: new Date()
                }, { merge: true });

                // tenta recarregar currentUser (se disponível)
                try {
                    if (auth.currentUser && typeof auth.currentUser.reload === 'function') {
                        await auth.currentUser.reload();
                    }
                } catch (reloadErr) {
                    console.warn('Não foi possível recarregar currentUser:', reloadErr);
                }

                // garante que exibimos a URL definitiva
                if (photoURL) userPhoto.src = photoURL;

                alert("Perfil atualizado com sucesso!");
            } catch (err) {
                console.error("Erro ao salvar perfil:", err);
                alert("Erro ao salvar: " + (err.message || "Tente novamente."));
            }
        });

        logoutBtn.addEventListener("click", async () => {
            await signOut(auth);
            window.location.href = "login.html";
        });
    </script>
</body>

</html>
