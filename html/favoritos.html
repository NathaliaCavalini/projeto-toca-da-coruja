<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Favoritos — Toca da Coruja</title>
  <link rel="stylesheet" href="../css/home.css">
  <link rel="icon" href="../imagens/favicon.png" type="image/png">
</head>
<body>
  <!-- Sidebar (puxe sua sidebar real se quiser) -->
  <aside class="sidebar">
    <header class="logo">
      <img src="../imagens/logo.png" alt="Logo Toca da Coruja" class="logo-img">
      <h1>Toca <br> da Coruja</h1>
    </header>
    <nav class="menu">
      <ul>
        <li><a href="../home.html">Catálogo</a></li>
        <li><a href="./quer_ler.html">Quer ler</a></li>
        <li><a href="./ja_lidos.html">Já lidos</a></li>
      </ul>
    </nav>
    <a id="user-info" href="./login.html" class="user-info-link"></a>
  </aside>

  <main class="main-content">
    <nav class="top-nav"><a href="../home.html">← Voltar ao catálogo</a></nav>

    <section class="list-page">
      <h1>Favoritos</h1>
      <div id="favoritos-container" class="book-grid" aria-live="polite"></div>
      <p id="empty-msg" class="list-empty" style="display:none;">Nenhum favorito ainda.</p>
    </section>
  </main>

  <footer class="footer">© Toca da Coruja</footer>

  <!-- Global scripts -->
  <script src="/js/library-actions-delegated.js"></script>
  <script type="module" src="/js/user-info-global.js"></script>

  <!-- Renderizador local da lista "favoritos" (autônomo) -->
  <script>
  (function(){
    const LIST_SUFFIX = '::favoritos';
    const container = document.getElementById('favoritos-container');
    const emptyMsg = document.getElementById('empty-msg');

    function findListKey(){
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.endsWith(LIST_SUFFIX)) return k;
      }
      return 'guest' + LIST_SUFFIX;
    }
    function loadListByKey(k){
      try { return JSON.parse(localStorage.getItem(k)) || []; } catch(e){ return []; }
    }
    function saveListByKey(k, arr){ localStorage.setItem(k, JSON.stringify(arr)); }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function render(){
      const key = findListKey();
      const items = loadListByKey(key);
      if(!items || items.length === 0){
        emptyMsg.style.display = 'block';
        container.innerHTML = '';
        return;
      }
      emptyMsg.style.display = 'none';
      container.innerHTML = items.map(b => `
        <article class="book-item" data-id="${escapeHtml(b.id)}" data-title="${escapeHtml(b.title)}">
          <div class="book-card">
            <img src="${escapeHtml(b.img || '../imagens/sem-capa.png')}" alt="${escapeHtml(b.title)}">
          </div>
          <div class="book-title"><p>${escapeHtml(b.title)}</p></div>
          <div class="book-actions">
            <button class="action-btn btn-quer-ler">Quero Ler</button>
            <button class="action-btn btn-ja-li">Já Li</button>
            <button class="action-btn btn-favorito">♥</button>
            <button class="action-btn btn-remove" data-book-id="${escapeHtml(b.id)}" aria-label="Remover ${escapeHtml(b.title)}">Remover</button>
            <a class="action-link" href="./vejamais.html?id=${encodeURIComponent(b.id)}">Ver detalhes</a>
          </div>
        </article>
      `).join('');
      // Atualiza estados visuais dos botões caso necessário
      setTimeout(()=> { try{ window.__libraryActions?.refreshAll?.(); } catch(e){} }, 80);
    }

    // Remover item (apenas desta lista)
    container.addEventListener('click', function(e){
      const btn = e.target.closest && e.target.closest('.btn-remove');
      if(!btn) return;
      const bookId = btn.dataset.bookId;
      if(!bookId) return;
      const key = findListKey();
      let items = loadListByKey(key);
      items = items.filter(x => x.id !== bookId);
      saveListByKey(key, items);
      render();
    });

    // Intercepta cliques dos botões dentro da própria página para evitar redirecionamento imediato
    document.addEventListener('click', function(e){
      const btn = e.target.closest && e.target.closest('.btn-quer-ler, .btn-ja-li, .btn-favorito, [id^="btn-quer-ler"], [id^="btn-ja-li"], [id^="btn-favorito"]');
      if(!btn) return;
      if(container.contains(btn)){
        // permite que o library-actions grave a alteração, depois re-renderiza sem sair da página
        setTimeout(()=> { try{ window.__libraryActions?.refreshAll?.(); render(); } catch(e){} }, 220);
      }
    });

    // Inicializa render
    render();

    // expõe utilitário para debug se necessário
    window.__favoritosPage = { render };
  })();
  </script>
</body>
</html>
