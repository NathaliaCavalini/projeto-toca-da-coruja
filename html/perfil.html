<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil – Toca da Coruja</title>
    <link rel="stylesheet" href="../css/perfil.css" />
</head>

<body>
    <div class="perfil-container">
        <h1>Meu Perfil</h1>
        <img id="user-photo" src="../imagens/user.png" alt="Foto do usuário" width="120" height="120"
            style="border-radius:50%;">
        <form id="profile-form">
            <label>Nome de usuário</label>
            <input type="text" id="username" />

            <label>E-mail</label>
            <input type="email" id="email" disabled />

            <label>Foto (arquivo)</label>
            <input type="file" id="photo-file" accept="image/*" />

            <button type="submit">Salvar Alterações</button>
        </form>

        <button id="logout-btn">Sair</button>
    </div>

    <script type="module">
        import { auth, db, storage } from "../js/firebase-config.js";
        import { onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

        const username = document.getElementById("username");
        const email = document.getElementById("email");
        const photoFile = document.getElementById("photo-file");
        const userPhoto = document.getElementById("user-photo");
        const profileForm = document.getElementById("profile-form");
        const logoutBtn = document.getElementById("logout-btn");

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "login.html";
                return;
            }
            // preenche campos
            username.value = user.displayName || "";
            email.value = user.email || "";
            userPhoto.src = user.photoURL || "../imagens/user.png";

            // tenta buscar dados extras no Firestore
            try {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.photoURL) userPhoto.src = data.photoURL;
                }
            } catch (err) { console.warn(err); }
        });

        profileForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return alert("Usuário não encontrado.");

            try {
                let photoURL = user.photoURL || "";
                const file = photoFile.files[0];
                if (file) {
                    // faz upload para storage em /avatars/<uid>
                    const storageRef = ref(storage, `avatars/${user.uid}/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    photoURL = await getDownloadURL(storageRef);
                }

                // atualiza Auth
                await updateProfile(user, { displayName: username.value, photoURL });

                // atualiza Firestore
                await setDoc(doc(db, "usuarios", user.uid), {
                    displayName: username.value,
                    email: user.email,
                    photoURL,
                    updatedAt: new Date()
                }, { merge: true });

                alert("Perfil atualizado!");
                location.reload();
            } catch (err) {
                console.error(err);
                alert("Erro ao salvar: " + (err.message || err));
            }
        });

        logoutBtn.addEventListener("click", async () => {
            await signOut(auth);
            window.location.href = "login.html";
        });
    </script>
</body>

</html>